<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarawak Food Court - Welcome</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/customer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="landing-page">
    <div class="container">
        <div class="welcome-section">
            <div class="logo">
                <i class="fas fa-utensils"></i>
            </div>
            <h1>Welcome to Sarawak Food Court</h1>
            <p class="tagline">Order from multiple stalls, one easy checkout</p>
            
            <div class="qr-scanner-section">
                <div class="qr-icon">
                    <i class="fas fa-qrcode"></i>
                </div>
                <h2>Scan Table QR Code</h2>
                <p>Each table has a unique QR code to start ordering</p>
                
                <!-- Real QR Scanner -->
                <button class="btn-primary btn-large" onclick="startRealScan()">
                    <i class="fas fa-camera"></i> Scan QR Code
                </button>
                
                <!-- QR Code Scanner Container (Hidden initially) -->
                <div id="qr-reader" style="display: none; margin: 1.5rem 0; border-radius: 12px; overflow: hidden;"></div>
                <button id="stopScanBtn" class="btn-secondary" onclick="stopScan()" style="display: none; margin-top: 1rem;">
                    <i class="fas fa-times"></i> Stop Scanning
                </button>
                
                <!-- Or select table for testing -->
                <div class="divider">
                    <span>OR</span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label for="tableSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                        <i class="fas fa-table"></i> Select Your Table (Testing):
                    </label>
                    <select id="tableSelect" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; background-color: white;">
                        <option value="">Choose a table number...</option>
                        <option value="1">Table 1</option>
                        <option value="2">Table 2</option>
                        <option value="3">Table 3</option>
                        <option value="4">Table 4</option>
                        <option value="5">Table 5</option>
                        <option value="6">Table 6</option>
                        <option value="7">Table 7</option>
                        <option value="8">Table 8</option>
                        <option value="9">Table 9</option>
                        <option value="10">Table 10</option>
                        <option value="11">Table 11</option>
                        <option value="12">Table 12</option>
                        <option value="13">Table 13</option>
                        <option value="14">Table 14</option>
                        <option value="15">Table 15</option>
                        <option value="16">Table 16</option>
                        <option value="17">Table 17</option>
                        <option value="18">Table 18</option>
                        <option value="19">Table 19</option>
                        <option value="20">Table 20</option>
                    </select>
                </div>
                
                <button class="btn-secondary btn-large" onclick="enterWithTable()">
                    <i class="fas fa-arrow-right"></i> Enter with Selected Table
                </button>
            </div>
            
            <div class="info-cards">
                <div class="info-card">
                    <i class="fas fa-store"></i>
                    <h3>Multiple Stalls</h3>
                    <p>Order from different food stalls in one go</p>
                </div>
                <div class="info-card">
                    <i class="fas fa-mobile-alt"></i>
                    <h3>Easy Payment</h3>
                    <p>Quick QR code payment for each stall</p>
                </div>
                <div class="info-card">
                    <i class="fas fa-bell"></i>
                    <h3>Real-time Updates</h3>
                    <p>Track your order status live</p>
                </div>
            </div>
            
            <div class="footer-links">
                <a href="hawker/login.html">Hawker Login</a>
                <span>|</span>
                <a href="admin/login.html">Admin</a>
            </div>
        </div>
    </div>
    
    <script>
        let html5QrcodeScanner = null;

        // Real QR Code Scanner using phone camera
        function startRealScan() {
            const qrReader = document.getElementById('qr-reader');
            const stopBtn = document.getElementById('stopScanBtn');
            const startBtn = event.target.closest('button');
            
            // Show scanner
            qrReader.style.display = 'block';
            stopBtn.style.display = 'block';
            startBtn.style.display = 'none';
            
            // Initialize scanner
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            
            // Start scanning with back camera
            html5QrcodeScanner.start(
                { facingMode: "environment" }, // Use back camera
                {
                    fps: 10,    // Frames per second
                    qrbox: { width: 250, height: 250 }  // Scanning box size
                },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Camera error:", err);
                alert("❌ Camera access denied or not available. Please:\n\n1. Allow camera permissions\n2. Use HTTPS (required for camera)\n3. Or use the table selector below");
                stopScan();
            });
        }

        // When QR code is successfully scanned
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`QR Code detected: ${decodedText}`);

            // Stop scanning
            stopScan();

            // Check if QR contains a full URL (starts with http:// or https://)
            if (decodedText.startsWith('http://') || decodedText.startsWith('https://')) {
                // Extract parameters from URL for localStorage
                try {
                    const url = new URL(decodedText);
                    const foodcourt = url.searchParams.get('foodcourt');
                    const table = url.searchParams.get('table');
                    const stall = url.searchParams.get('stall');
                    
                    // Store table number if present
                    if (table) {
                        localStorage.setItem('tableNumber', table);
                    }
                    
                    // Store session start time
                    localStorage.setItem('sessionStart', new Date().toISOString());
                    
                    // Show success message
                    if (table) {
                        alert(`✅ Table ${table} detected! Redirecting...`);
                    } else {
                        alert(`✅ QR Code detected! Redirecting...`);
                    }
                    
                    // Navigate directly to the URL
                    window.location.href = decodedText;
                    return;
                } catch (error) {
                    console.error('Error parsing URL:', error);
                    // Fall through to pattern matching below
                }
            }

            // Try extract stall id first (if QR encodes a specific stall/menu)
            const stallId = extractStallId(decodedText);
            // Extract table number as a fallback (if QR encodes the table)
            const tableNumber = extractTableNumber(decodedText);

            if (stallId) {
                // If the QR points to a specific stall, store table if present and go straight to that stall menu
                if (tableNumber) {
                    localStorage.setItem('tableNumber', tableNumber);
                }
                localStorage.setItem('sessionStart', new Date().toISOString());
                alert(`✅ Opening menu for stall ${stallId}...`);
                window.location.href = `customer/menu.html?stall=${stallId}`;
                return;
            }

            if (tableNumber) {
                // Store table info
                localStorage.setItem('tableNumber', tableNumber);
                localStorage.setItem('sessionStart', new Date().toISOString());

                // Show success message
                alert(`✅ Table ${tableNumber} detected! Redirecting...`);

                // Redirect to customer home (list of stalls)
                window.location.href = 'customer/home.html';
                return;
            }

            // Nothing matched - show error and restart scanner
            alert('❌ Invalid QR code. Please scan a valid table or stall QR code.');
            setTimeout(() => startRealScan(), 1000);
        }

        // Handle scan failures (can be ignored for most cases)
        function onScanFailure(error) {
            // This is called frequently while scanning - don't show alerts
            // console.log(`Scan error: ${error}`);
        }

        // Extract table number from QR code text
        function extractTableNumber(qrText) {
            // Try different patterns
            // Pattern 1: Direct number (e.g., "5")
            if (/^\d+$/.test(qrText)) {
                return qrText;
            }
            
            // Pattern 2: "table-5" or "Table-5"
            let match = qrText.match(/table[-_\s]*(\d+)/i);
            if (match) {
                return match[1];
            }
            
            // Pattern 3: URL like "https://site.com/table/5" or "https://site.com?table=5"
            match = qrText.match(/table[\/=](\d+)/i);
            if (match) {
                return match[1];
            }
            
            // If no pattern matches, return null
            return null;
        }

        // Extract stall id from QR code text (if QR encodes a specific stall/menu)
        function extractStallId(qrText) {
            if (!qrText) return null;

            // Pattern: "stall-5" or "stall/5" or query param "?stall=5"
            let match = qrText.match(/stall[-_\/]?(\d+)/i);
            if (match) return match[1];

            match = qrText.match(/[?&]stall=(\d+)/i);
            if (match) return match[1];

            // Pattern: URL containing /menu/ or /stall/ followed by id
            match = qrText.match(/(?:menu|stall)[\/=](\d+)/i);
            if (match) return match[1];

            return null;
        }

        // Stop the scanner
        function stopScan() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(ignore => {
                    document.getElementById('qr-reader').style.display = 'none';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    document.querySelector('.btn-primary').style.display = 'inline-flex';
                }).catch(err => {
                    console.error("Stop error:", err);
                });
            }
        }
        
        function enterWithTable() {
            const tableSelect = document.getElementById('tableSelect');
            const tableNumber = tableSelect.value;
            
            if (!tableNumber) {
                alert('⚠️ Please select a table number first');
                tableSelect.focus();
                return;
            }
            
            // Store table info
            localStorage.setItem('tableNumber', tableNumber);
            localStorage.setItem('sessionStart', new Date().toISOString());
            
            // Visual feedback
            const btn = event.target.closest('button');
            btn.innerHTML = '<i class="fas fa-check"></i> Table ' + tableNumber + ' Selected!';
            btn.style.background = 'var(--success-color)';
            btn.disabled = true;
            
            // Redirect
            setTimeout(() => {
                window.location.href = 'customer/home.html';
            }, 500);
        }
        
        // Auto-submit on Enter key
        window.addEventListener('DOMContentLoaded', () => {
            const tableSelect = document.getElementById('tableSelect');
            
            if (tableSelect) {
                tableSelect.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && tableSelect.value) {
                        enterWithTable();
                    }
                });
                
                // Highlight button when table selected
                tableSelect.addEventListener('change', () => {
                    if (tableSelect.value) {
                        const btn = document.querySelector('.btn-secondary');
                        btn.style.animation = 'pulse 0.5s';
                        setTimeout(() => {
                            btn.style.animation = '';
                        }, 500);
                    }
                });
            }
        });
    </script>
</body>
</html>
