<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Hawker Portal</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/hawker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="hawker-dashboard">
    <nav class="top-nav">
        <div class="nav-brand" style="display: flex; width: 100%; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-cog"></i>
                <span style="font-size: 0.95em; font-weight: 500;">Settings</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                <span id="stallNameHeader" style="font-size: 1.1em; font-weight: 600;">Loading...</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <span id="foodCourtName" style="font-size: 0.85em; opacity: 0.75;">Loading...</span>
            </div>
        </div>
    </nav>
    
    <main class="dashboard-content">
        <div class="settings-container">
            <div class="settings-section">
                <h2><i class="fas fa-store"></i> Stall Information</h2>
                <form class="settings-form">
                    <div class="form-group">
                        <label>Stall Name</label>
                        <input type="text" id="stallName" value="">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="stallDescription" rows="3"></textarea>
                    </div>
                    <button type="button" class="btn-primary" onclick="saveStallInfo()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </form>
            </div>
            
            <div class="settings-section">
                <h2><i class="fas fa-qrcode"></i> Payment QR Code</h2>
                <div class="qr-upload-section">
                    <div class="current-qr" id="currentQR">
                        <img src="../assets/images/qr-codes/default-qr.png" alt="Current QR" id="qrPreview">
                    </div>
                    <div class="qr-upload-controls">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="btn-primary" onclick="document.getElementById('qrFileInput').click()" style="flex: 1;">
                                <i class="fas fa-image"></i> Choose Image File
                            </button>
                            <input type="file" id="qrFileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                        </div>
                        <div style="text-align: center; margin: 0.75rem 0; color: #7F8C8D; font-weight: 600;">OR</div>
                        <input type="text" id="qrUrl" placeholder="Enter QR code image URL" style="margin-bottom: 0.5rem;">
                        <button class="btn-primary" onclick="updateQR()">
                            <i class="fas fa-link"></i> Update from URL
                        </button>
                        <p class="help-text">Upload your payment QR code (Touch 'n Go, GrabPay, etc.)</p>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h2><i class="fas fa-clock"></i> Operating Hours</h2>
                <div class="toggle-switch">
                    <label>
                        <input type="checkbox" id="isOpen" checked>
                        <span>Stall is currently open</span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h2><i class="fas fa-sign-out-alt"></i> Account</h2>
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </main>
    
    <nav class="bottom-nav hawker-nav">
        <a href="orders.html" class="nav-item">
            <i class="fas fa-receipt"></i>
            <span>Orders</span>
        </a>
        <a href="order-history.html" class="nav-item">
            <i class="fas fa-history"></i>
            <span>History</span>
        </a>
        <a href="menu-management.html" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="settings.html" class="nav-item active">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </nav>
    
    <script src="../js/app.js"></script>
    <script>
        let session = null;
        let supabase;
        let hawkerStall = null;
        
        // Initialize Supabase
        function initializeSupabase() {
            try {
                const SUPABASE_URL = 'https://mtmkghuhhrerlcubhzot.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bWtnaHVoaHJlcmxjdWJoem90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Mzc5NzIsImV4cCI6MjA3NzExMzk3Mn0.kA-NUWidhSRNPotmVe3KIclk8LpizR26DzxIBn5C1rA';
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase connected successfully!');
                return true;
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (initializeSupabase()) {
                checkAuth();
                loadSettings();
            }
        });
        
        async function checkAuth() {
            const sessionData = localStorage.getItem('hawkerSession') || sessionStorage.getItem('hawkerSession');
            if (!sessionData) {
                window.location.href = 'login.html';
                return;
            }
            session = JSON.parse(sessionData);
            
            // Load hawker stall information from Supabase to get food court name
            try {
                const { data, error } = await supabase
                    .from('hawker_stalls')
                    .select(`
                        *,
                        food_courts:food_court_id (
                            name,
                            address
                        )
                    `)
                    .eq('hawker_id', session.userId)
                    .eq('status', 'active')
                    .single();
                
                if (error) throw error;
                
                hawkerStall = data;
                // Display food court name and stall name
                document.getElementById('foodCourtName').textContent = data.food_courts?.name || 'Food Court';
                document.getElementById('stallNameHeader').textContent = data.stall_name || session.stallName || 'My Stall';
                
                console.log('✅ Hawker stall loaded:', hawkerStall);
            } catch (error) {
                console.error('❌ Error loading hawker stall:', error);
                document.getElementById('foodCourtName').textContent = 'Food Court';
                document.getElementById('stallNameHeader').textContent = session.stallName || 'My Stall';
            }
        }
        
        async function loadSettings() {
            // Wait for hawkerStall to be loaded
            if (!hawkerStall) {
                setTimeout(loadSettings, 100);
                return;
            }
            
            try {
                // Load stall information from Supabase
                document.getElementById('stallName').value = hawkerStall.stall_name || '';
                document.getElementById('stallDescription').value = hawkerStall.description || '';
                document.getElementById('isOpen').checked = hawkerStall.is_open || false;
                
                if (hawkerStall.qr_code_url) {
                    document.getElementById('qrPreview').src = hawkerStall.qr_code_url;
                    document.getElementById('qrUrl').value = hawkerStall.qr_code_url;
                }
                
                console.log('✅ Settings loaded');
            } catch (error) {
                console.error('❌ Error loading settings:', error);
            }
        }
        
        async function saveStallInfo() {
            if (!hawkerStall) {
                showToast('Error: Stall information not loaded', 'error');
                return;
            }
            
            const newStallName = document.getElementById('stallName').value.trim();
            const newDescription = document.getElementById('stallDescription').value.trim();
            
            if (!newStallName) {
                showToast('Stall name cannot be empty', 'error');
                return;
            }
            
            try {
                // Show loading
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                btn.disabled = true;
                
                // Update in Supabase
                const { data, error } = await supabase
                    .from('hawker_stalls')
                    .update({
                        stall_name: newStallName,
                        description: newDescription,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', hawkerStall.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update local hawkerStall object
                hawkerStall.stall_name = newStallName;
                hawkerStall.description = newDescription;
                
                // Update header display
                document.getElementById('stallNameHeader').textContent = newStallName;
                
                // Update session
                session.stallName = newStallName;
                const storageKey = localStorage.getItem('hawkerSession') ? 'hawkerSession' : 'hawkerSession';
                if (localStorage.getItem('hawkerSession')) {
                    localStorage.setItem('hawkerSession', JSON.stringify(session));
                } else {
                    sessionStorage.setItem('hawkerSession', JSON.stringify(session));
                }
                
                console.log('✅ Stall information updated:', data);
                showToast('Stall information updated successfully!');
                
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('❌ Error saving stall info:', error);
                showToast('Failed to update stall information: ' + error.message, 'error');
                
                // Restore button
                event.target.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                event.target.disabled = false;
            }
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size must be less than 5MB', 'error');
                return;
            }
            
            try {
                showToast('Uploading image...', 'warning');
                
                // Convert image to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Image = e.target.result;
                    
                    try {
                        const session = JSON.parse(localStorage.getItem('hawkerSession') || sessionStorage.getItem('hawkerSession'));
                        
                        if (!session || !session.stallId) {
                            showToast('Session expired. Please login again.', 'error');
                            setTimeout(() => window.location.href = 'login.html', 1500);
                            return;
                        }
                        
                        // Update QR code in database with base64 image
                        const { data, error } = await supabase
                            .from('hawker_stalls')
                            .update({ qr_code_url: base64Image })
                            .eq('id', session.stallId)
                            .select()
                            .single();
                        
                        if (error) throw error;
                        
                        // Update preview
                        document.getElementById('qrPreview').src = base64Image;
                        showToast('QR code image uploaded successfully!');
                        console.log('✅ QR code uploaded:', data);
                        
                    } catch (error) {
                        console.error('❌ Error uploading QR code:', error);
                        showToast('Failed to upload QR code: ' + error.message, 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('Failed to read image file', 'error');
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('❌ Error processing image:', error);
                showToast('Failed to process image: ' + error.message, 'error');
            }
        }

        async function updateQR() {
            const qrUrl = document.getElementById('qrUrl').value;
            
            if (!qrUrl) {
                showToast('Please enter a QR code URL', 'error');
                return;
            }
            
            // Validate URL format
            try {
                new URL(qrUrl);
            } catch (e) {
                showToast('Please enter a valid URL', 'error');
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('hawkerSession') || sessionStorage.getItem('hawkerSession'));
                
                if (!session || !session.stallId) {
                    showToast('Session expired. Please login again.', 'error');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                    return;
                }
                
                // Update QR code in database
                const { data, error } = await supabase
                    .from('hawker_stalls')
                    .update({ qr_code_url: qrUrl })
                    .eq('id', session.stallId)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update preview
                document.getElementById('qrPreview').src = qrUrl;
                showToast('QR code updated successfully!');
                console.log('✅ QR code updated:', data);
                
            } catch (error) {
                console.error('❌ Error updating QR code:', error);
                showToast('Failed to update QR code: ' + error.message, 'error');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear session data
                localStorage.removeItem('hawkerSession');
                sessionStorage.removeItem('hawkerSession');
                
                // Redirect to login page
                window.location.href = 'login.html';
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'error' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 
                        'check-circle';
            
            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
