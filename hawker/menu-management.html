<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management - Hawker Portal</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/hawker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="hawker-dashboard">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-brand" style="display: flex; width: 100%; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-utensils"></i>
                <span style="font-size: 0.95em; font-weight: 500;">Menu</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                <span id="stallName" style="font-size: 1.1em; font-weight: 600;">Loading...</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <span id="foodCourtName" style="font-size: 0.85em; opacity: 0.75;">Loading...</span>
            </div>
        </div>
    </nav>
    
    <main class="dashboard-content">
        <!-- Menu Items Grid -->
        <div class="menu-management" id="menuItems">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading menu...</p>
            </div>
        </div>
    </main>
    
    <!-- Floating Add Button -->
    <button class="fab-button" onclick="showAddItemModal()" title="Add New Item">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- Add/Edit Item Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="modalTitle">Add Menu Item</h2>
                <button class="modal-close" onclick="closeItemModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="modal-body" id="itemForm" onsubmit="saveItem(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemName">Item Name *</label>
                        <input type="text" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label for="itemPrice">Price (RM) *</label>
                        <input type="number" id="itemPrice" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="itemDescription">Description *</label>
                    <textarea id="itemDescription" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="itemCategory">Category *</label>
                    <select id="itemCategory" required>
                        <option value="Main">Main Dish</option>
                        <option value="Side">Side Dish</option>
                        <option value="Drink">Drink</option>
                        <option value="Dessert">Dessert</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="itemImageUpload">Upload Image</label>
                    <div class="image-upload-container">
                        <div class="image-preview" id="imagePreview">
                            <i class="fas fa-image"></i>
                            <p>No image selected</p>
                        </div>
                        <input type="file" id="itemImageUpload" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">
                        <button type="button" class="btn-upload" onclick="document.getElementById('itemImageUpload').click()">
                            <i class="fas fa-upload"></i> Choose Image
                        </button>
                        <button type="button" class="btn-remove" id="removeImageBtn" onclick="removeImage()" style="display: none;">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <input type="hidden" id="itemImage">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="itemAvailable" checked>
                            Available for order
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="itemPopular">
                            Mark as popular
                        </label>
                    </div>
                </div>
                
                <input type="hidden" id="itemId">
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeItemModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Item
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav hawker-nav">
        <a href="orders.html" class="nav-item">
            <i class="fas fa-receipt"></i>
            <span>Orders</span>
        </a>
        <a href="order-history.html" class="nav-item">
            <i class="fas fa-history"></i>
            <span>History</span>
        </a>
        <a href="menu-management.html" class="nav-item active">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="settings.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </nav>
    
    <script src="../js/app.js"></script>
    <script src="../js/hawker.js"></script>
    <script>
        let session = null;
        let menuItems = [];
        let editingItemId = null;
        let myStallId = null;
        let supabase;
        let hawkerStall = null;
        
        // Initialize Supabase
        function initializeSupabase() {
            try {
                const SUPABASE_URL = 'https://mtmkghuhhrerlcubhzot.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bWtnaHVoaHJlcmxjdWJoem90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Mzc5NzIsImV4cCI6MjA3NzExMzk3Mn0.kA-NUWidhSRNPotmVe3KIclk8LpizR26DzxIBn5C1rA';
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase connected successfully!');
                return true;
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (initializeSupabase()) {
                checkAuth();
                loadMenu();
            }
        });
        
        async function checkAuth() {
            const sessionData = localStorage.getItem('hawkerSession') || sessionStorage.getItem('hawkerSession');
            if (!sessionData) {
                window.location.href = 'login.html';
                return;
            }
            session = JSON.parse(sessionData);
            
            // Load hawker stall information from Supabase to get food court name
            try {
                const { data, error } = await supabase
                    .from('hawker_stalls')
                    .select(`
                        *,
                        food_courts:food_court_id (
                            name,
                            address
                        )
                    `)
                    .eq('hawker_id', session.userId)
                    .eq('status', 'active')
                    .single();
                
                if (error) throw error;
                
                hawkerStall = data;
                // Display food court name and stall name
                document.getElementById('foodCourtName').textContent = data.food_courts?.name || 'Food Court';
                document.getElementById('stallName').textContent = data.stall_name || session.stallName || 'My Stall';
                
                console.log('✅ Hawker stall loaded:', hawkerStall);
            } catch (error) {
                console.error('❌ Error loading hawker stall:', error);
                document.getElementById('foodCourtName').textContent = 'Food Court';
                document.getElementById('stallName').textContent = session.stallName || 'My Stall';
            }
        }
        
        async function loadMenu() {
            try {
                // Get stall ID from session
                if (!session.stallId) {
                    console.error('No stall ID in session');
                    displayMenu();
                    return;
                }
                
                myStallId = session.stallId;
                console.log('My Stall ID from session:', myStallId);
                console.log('My Stall Name:', session.stallName);
                
                // Load menu items from Supabase
                console.log('Loading menu items from Supabase for stall:', myStallId);
                const { data: supabaseMenus, error } = await supabase
                    .from('menu_items')
                    .select('*')
                    .eq('stall_id', myStallId)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('❌ Error loading from Supabase:', error);
                    // Fall back to localStorage
                    const localMenus = localStorage.getItem('menus');
                    let allMenus = [];
                    
                    if (localMenus) {
                        console.log('Falling back to localStorage');
                        allMenus = JSON.parse(localMenus);
                    } else {
                        console.log('No menus in localStorage either');
                        allMenus = [];
                    }
                    
                    menuItems = allMenus.filter(item => item.stallId === myStallId);
                    console.log('Loaded from localStorage. My menu items:', menuItems.length);
                } else {
                    console.log('✅ Loaded from Supabase:', supabaseMenus?.length || 0, 'items');
                    
                    // Convert Supabase format to local format
                    menuItems = (supabaseMenus || []).map(item => ({
                        id: item.id,
                        stallId: item.stall_id,
                        name: item.name,
                        price: parseFloat(item.price),
                        description: item.description,
                        category: item.category,
                        image: item.image_url || 'https://via.placeholder.com/300?text=No+Image',
                        available: item.available,
                        isPopular: item.is_popular || false
                    }));
                    
                    // Also update localStorage for offline access
                    const localMenus = localStorage.getItem('menus');
                    let allMenus = localMenus ? JSON.parse(localMenus) : [];
                    
                    // Remove old items for this stall from localStorage
                    allMenus = allMenus.filter(item => item.stallId !== myStallId);
                    
                    // Add the current items
                    allMenus.push(...menuItems);
                    
                    localStorage.setItem('menus', JSON.stringify(allMenus));
                    console.log('Synced to localStorage. Total menus:', allMenus.length);
                }
                
                displayMenu();
            } catch (error) {
                console.error('Error loading menu:', error);
                displayMenu();
            }
        }
        
        function displayMenu() {
            const container = document.getElementById('menuItems');
            
            if (menuItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <p>No menu items yet</p>
                        <button class="btn-primary" onclick="showAddItemModal()">
                            <i class="fas fa-plus"></i> Add Your First Item
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = menuItems.map(item => `
                <div class="menu-card ${!item.available ? 'unavailable' : ''}" style="background-image: url('${item.image}')">
                    <div class="menu-card-overlay">
                        <div class="menu-card-header">
                            <div class="menu-item-info">
                                <h3>${item.name}</h3>
                                <span class="menu-price">RM ${item.price.toFixed(2)}</span>
                            </div>
                            <span class="menu-category-badge">${item.category}</span>
                        </div>
                        
                        <div class="menu-card-footer">
                            ${item.isPopular ? '<span class="popular-tag"><i class="fas fa-star"></i> Popular</span>' : '<span></span>'}
                            <div class="menu-card-actions">
                                <button class="action-btn ${item.available ? 'btn-available' : 'btn-unavailable'}" onclick="toggleAvailability('${item.id}')" title="${item.available ? 'Available' : 'Unavailable'}">
                                    <i class="fas fa-${item.available ? 'eye' : 'eye-slash'}"></i>
                                </button>
                                <button class="action-btn btn-edit" onclick="editItem('${item.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showAddItemModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'Add Menu Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemImage').value = '';
            
            // Reset image preview
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '<i class="fas fa-image"></i><p>No image selected</p>';
            preview.style.backgroundImage = '';
            document.getElementById('removeImageBtn').style.display = 'none';
            
            document.getElementById('itemModal').classList.add('show');
        }
        
        function editItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            editingItemId = itemId;
            document.getElementById('modalTitle').textContent = 'Edit Menu Item';
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemDescription').value = item.description;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemImage').value = item.image;
            document.getElementById('itemAvailable').checked = item.available;
            document.getElementById('itemPopular').checked = item.isPopular || false;
            
            // Show image preview if exists
            const preview = document.getElementById('imagePreview');
            if (item.image) {
                preview.style.backgroundImage = `url('${item.image}')`;
                preview.innerHTML = '';
                document.getElementById('removeImageBtn').style.display = 'inline-block';
            } else {
                preview.innerHTML = '<i class="fas fa-image"></i><p>No image selected</p>';
                preview.style.backgroundImage = '';
                document.getElementById('removeImageBtn').style.display = 'none';
            }
            
            document.getElementById('itemModal').classList.add('show');
        }
        
        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            editingItemId = null;
        }
        
        async function saveItem(event) {
            event.preventDefault();
            
            // Use the stored stall ID
            if (!myStallId) {
                showToast('Error: Stall ID not found. Please refresh the page.', 'error');
                return;
            }
            
            const itemData = {
                id: editingItemId || Date.now(),
                stallId: myStallId,
                name: document.getElementById('itemName').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                description: document.getElementById('itemDescription').value,
                category: document.getElementById('itemCategory').value,
                image: document.getElementById('itemImage').value || 'https://via.placeholder.com/300?text=No+Image',
                available: document.getElementById('itemAvailable').checked,
                isPopular: document.getElementById('itemPopular').checked
            };
            
            console.log('Saving item:', itemData);
            
            try {
                // Prepare data for Supabase
                const supabaseData = {
                    stall_id: myStallId,
                    name: itemData.name,
                    description: itemData.description,
                    price: itemData.price,
                    category: itemData.category,
                    image_url: itemData.image,
                    available: itemData.available,
                    is_popular: itemData.isPopular
                };
                
                if (editingItemId) {
                    // Update existing item in Supabase
                    console.log('Updating item in Supabase with ID:', editingItemId);
                    const { data, error } = await supabase
                        .from('menu_items')
                        .update(supabaseData)
                        .eq('id', editingItemId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    console.log('✅ Item updated in Supabase:', data);
                    
                    // Update in local array
                    const localIndex = menuItems.findIndex(i => i.id === editingItemId);
                    if (localIndex !== -1) {
                        menuItems[localIndex] = itemData;
                    }
                    
                    showToast('Item updated successfully!');
                } else {
                    // Insert new item into Supabase
                    console.log('Inserting new item into Supabase');
                    const { data, error } = await supabase
                        .from('menu_items')
                        .insert([supabaseData])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    console.log('✅ Item inserted into Supabase:', data);
                    
                    // Update the itemData with the actual ID from Supabase
                    itemData.id = data.id;
                    
                    // Add to local array
                    menuItems.push(itemData);
                    
                    showToast('Item added successfully!');
                }
                
                // Also save to localStorage for offline access
                let allMenus = JSON.parse(localStorage.getItem('menus') || '[]');
                
                if (editingItemId) {
                    const globalIndex = allMenus.findIndex(i => i.id === editingItemId);
                    if (globalIndex !== -1) {
                        allMenus[globalIndex] = itemData;
                    }
                } else {
                    allMenus.push(itemData);
                }
                
                localStorage.setItem('menus', JSON.stringify(allMenus));
                console.log('Saved to localStorage. Total menus:', allMenus.length);
                
                closeItemModal();
                displayMenu();
                
            } catch (error) {
                console.error('❌ Error saving item to Supabase:', error);
                showToast('Error saving item: ' + error.message, 'error');
            }
        }
        
        async function toggleAvailability(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            try {
                const newAvailability = !item.available;
                
                // Update in Supabase
                console.log('Updating availability in Supabase for item:', itemId);
                const { error } = await supabase
                    .from('menu_items')
                    .update({ available: newAvailability })
                    .eq('id', itemId);
                
                if (error) throw error;
                
                console.log('✅ Availability updated in Supabase');
                
                // Update locally
                item.available = newAvailability;
                
                // Update in localStorage
                const allMenus = JSON.parse(localStorage.getItem('menus') || '[]');
                const globalIndex = allMenus.findIndex(i => i.id === itemId);
                if (globalIndex !== -1) {
                    allMenus[globalIndex].available = newAvailability;
                    localStorage.setItem('menus', JSON.stringify(allMenus));
                }
                
                displayMenu();
                showToast(`Item marked as ${newAvailability ? 'available' : 'unavailable'}`);
            } catch (error) {
                console.error('❌ Error updating availability:', error);
                showToast('Error updating availability: ' + error.message, 'error');
            }
        }
        
        async function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            try {
                // Delete from Supabase
                console.log('Deleting item from Supabase:', itemId);
                const { error } = await supabase
                    .from('menu_items')
                    .delete()
                    .eq('id', itemId);
                
                if (error) throw error;
                
                console.log('✅ Item deleted from Supabase');
                
                // Remove from local array
                menuItems = menuItems.filter(i => i.id !== itemId);
                
                // Remove from localStorage
                const allMenus = JSON.parse(localStorage.getItem('menus') || '[]');
                const updatedMenus = allMenus.filter(i => i.id !== itemId);
                localStorage.setItem('menus', JSON.stringify(updatedMenus));
                
                displayMenu();
                showToast('Item deleted successfully!');
            } catch (error) {
                console.error('❌ Error deleting item:', error);
                showToast('Error deleting item: ' + error.message, 'error');
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select a valid image file', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size must be less than 5MB', 'error');
                return;
            }
            
            // Read file and convert to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                
                // Store in hidden input
                document.getElementById('itemImage').value = base64Image;
                
                // Show preview
                const preview = document.getElementById('imagePreview');
                preview.style.backgroundImage = `url('${base64Image}')`;
                preview.innerHTML = '';
                
                // Show remove button
                document.getElementById('removeImageBtn').style.display = 'inline-block';
                
                showToast('Image uploaded successfully!');
            };
            
            reader.onerror = function() {
                showToast('Failed to read image file', 'error');
            };
            
            reader.readAsDataURL(file);
        }
        
        function removeImage() {
            // Clear the image
            document.getElementById('itemImage').value = '';
            document.getElementById('itemImageUpload').value = '';
            
            // Reset preview
            const preview = document.getElementById('imagePreview');
            preview.style.backgroundImage = '';
            preview.innerHTML = '<i class="fas fa-image"></i><p>No image selected</p>';
            
            // Hide remove button
            document.getElementById('removeImageBtn').style.display = 'none';
            
            showToast('Image removed');
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'error' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 
                        'check-circle';
            
            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
